AWSTemplateFormatVersion: "2010-09-09"

Transform:
  - AWS::Serverless-2016-10-31
Description: >-
  This creates the necessary components to deploy the DCA FE onto ECS
  Fargate within an existing VPC and private subnets (imported parameters).
  DCA Front can be invoked via the public API Gateway on the url in the
  DCAFrontURL output.

  The ingress route in summary is: API Gateway -> VPC link -> Private ALB ->
  DCA Front ECS Service

  DCA Front egress to DCA API's API Gateway is via a NAT Gateway which
  should have a route in the provided private subnets' route table.

Parameters:
  Environment:
    Description: "The environment type"
    Type: "String"
    Default: dev
    AllowedValues:
      - "dev"
      - "build"
      - "staging"
      - "integration"
      - "production"
  VpcStackName:
    Description: >
      The name of the stack that defines the VPC in which this container will
      run.
    Type: String
    Default: platform-vpc
  BackendStackName:
    Description: >
      The name of the backend stack to depend on.  Is set to a default as not required for the higher envs.
    Type: String
    Default: backend-api
  ContainerPort:
    Description: >
      The port on which the container is running
    Type: Number
    Default: 5000
  DevFrontendContainer:
    Description: >
      The ECR container for overriding in development, if you want to target a specific version/tag
    Type: String
    Default: 709132032242.dkr.ecr.eu-west-2.amazonaws.com/di-ipv-dca-front-image:latest
  PermissionsBoundary:
    Description: "The ARN of the permissions boundary to apply when creating IAM roles"
    Type: String
    Default: "none"

Conditions:
  IsNotDevelopment: !Or
    - !Equals [ !Ref Environment, build ]
    - !Equals [ !Ref Environment, staging ]
    - !Equals [ !Ref Environment, integration ]
    - !Equals [ !Ref Environment, production ]
  IsProduction: !Equals [ !Ref Environment, production ]
  UsePermissionsBoundary:
    Fn::Not:
      - Fn::Equals:
          - !Ref PermissionsBoundary
          - "none"

Mappings:
  # see https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-access-logs.html
  PlatformConfiguration:
    dev:
      CSLSEGRESS: "This should not ever be set; the dev account is not configured to egress logs."
    build:
      CSLSEGRESS: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython
      CSLSEGRESSOLD: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prod
    staging:
      CSLSEGRESS: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython
      CSLSEGRESSOLD: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prod
    integration:
      CSLSEGRESS: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython
      CSLSEGRESSOLD: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prod
    production:
      CSLSEGRESS: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython
      CSLSEGRESSOLD: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prod
  ElasticLoadBalancerAccountIds:
    eu-west-2:
      AccountId: 652711504416
  EnvironmentVariables:
    ### These environment variables are referenced further down the file.
    ### Please ensure that any variables defined for an environment are defined for _all_ environments.
    dev:
      OAUTHENABLED: true
      CLIENTSTUBENABLED: true
      MOBILESTUBENABLED: true
      DESKTOPJOURNEYENABLED: true
      IPVCOREINTEGRATIONENABLED: false
      MULTIPLELANGUAGESENABLED: false
      ANDROIDENABLED: false
      APPSTOREURL: "https://not_available" # iOS app not available in dev
      MOBILEAPPID: "CQ3BV487G5.uk.co.deloitte.Identity.not_available" # iOS app not available in dev
      PLAYSTOREURL: "https://not_available" # Android app not available in dev
      ANDROIDAPPID: "uk.gov.documentchecking.not_available" # Android app not available in dev
      ANDROIDFINGERPRINT: "4B:82:A4:5E:79:2E:F4:95:63:67:46:5E:2F:73:14:34:E1:E9:5F:D0:34:3B:84:D0:3B:6B:96:5F:03:6D:48:CF" # Android app not available in dev (this is an invalid fingerprint)
      FEURL: "we_dont_know"
      APPURL: "app_we_dont_know"
      GTMCONTAINERID: "TK92W68"
      ANALYTICSCOOKIEDOMAIN: ".amazonaws.com"
      SERVICECOOKIEDOMAIN: ".amazonaws.com"
      ISSESSIONFINISHEDPOLLINGDURATION: "1800000" # 30 minutes in milliseconds
      ISSESSIONFINISHEDINTERVAL: "3000" # Time between API calls. 3 seconds in milliseconds
    build:
      OAUTHENABLED: true
      CLIENTSTUBENABLED: false
      MOBILESTUBENABLED: false
      DESKTOPJOURNEYENABLED: true
      IPVCOREINTEGRATIONENABLED: false
      MULTIPLELANGUAGESENABLED: false
      ANDROIDENABLED: false
      APPSTOREURL: "https://not_available" # iOS app not available in build
      MOBILEAPPID: "CQ3BV487G5.uk.co.deloitte.Identity.not_available" # iOS app not available in build
      PLAYSTOREURL: "https://not_available" # Android app not available in build
      ANDROIDAPPID: "uk.gov.documentchecking.not_available" # Android app not available in build
      ANDROIDFINGERPRINT: "4B:82:A4:5E:79:2E:F4:95:63:67:46:5E:2F:73:14:34:E1:E9:5F:D0:34:3B:84:D0:3B:6B:96:5F:03:6D:48:CF" # Android app not available in build (this is an invalid fingerprint)
      FEURL: "www.review-b.build.account.gov.uk"
      APPURL: "app.review-b.build.account.gov.uk"
      GTMCONTAINERID: "TK92W68"
      ANALYTICSCOOKIEDOMAIN: ".account.gov.uk"
      SERVICECOOKIEDOMAIN: ".account.gov.uk"
      ISSESSIONFINISHEDPOLLINGDURATION: "1800000" # 30 minutes in milliseconds
      ISSESSIONFINISHEDINTERVAL: "3000" # Time between API calls. 3 seconds in milliseconds
    staging:
      OAUTHENABLED: true
      CLIENTSTUBENABLED: false
      MOBILESTUBENABLED: false
      DESKTOPJOURNEYENABLED: true
      IPVCOREINTEGRATIONENABLED: false
      MULTIPLELANGUAGESENABLED: false
      ANDROIDENABLED: false
      APPSTOREURL: "https://beta.itunes.apple.com/v1/app/1633452907"
      MOBILEAPPID: "N8W395F695.uk.gov.digital-identity.staging"
      PLAYSTOREURL: "https://play.google.com/store/apps/details?id=uk.gov.documentchecking.staging"
      ANDROIDAPPID: "uk.gov.documentchecking.staging"
      ANDROIDFINGERPRINT: "4B:82:A4:5E:79:2E:F4:95:63:67:46:5E:2F:73:14:34:E1:E9:5F:D0:34:3B:84:D0:3B:6B:96:5F:03:6D:48:30"
      FEURL: "www.review-b.staging.account.gov.uk"
      APPURL: "app.review-b.staging.account.gov.uk"
      GTMCONTAINERID: "TK92W68"
      ANALYTICSCOOKIEDOMAIN: ".account.gov.uk"
      SERVICECOOKIEDOMAIN: ".account.gov.uk"
      ISSESSIONFINISHEDPOLLINGDURATION: "1800000" # 30 minutes in milliseconds
      ISSESSIONFINISHEDINTERVAL: "3000" # Time between API calls. 3 seconds in milliseconds
    integration:
      OAUTHENABLED: true
      CLIENTSTUBENABLED: false
      MOBILESTUBENABLED: false
      DESKTOPJOURNEYENABLED: true
      IPVCOREINTEGRATIONENABLED: false
      MULTIPLELANGUAGESENABLED: false
      ANDROIDENABLED: false
      APPSTOREURL: "https://beta.itunes.apple.com/v1/app/1629046409"
      MOBILEAPPID: "N8W395F695.uk.gov.digital-identity.beta"
      PLAYSTOREURL: "https://play.google.com/store/apps/details?id=uk.gov.documentchecking.integration"
      ANDROIDAPPID: "uk.gov.documentchecking.integration"
      ANDROIDFINGERPRINT: "63:14:50:EE:25:4F:91:E4:8A:B7:A6:51:E3:52:B4:E6:88:95:FD:75:70:EE:2C:1D:FF:F3:02:6A:82:14:B8:92"
      FEURL: "www.review-b.integration.account.gov.uk"
      APPURL: "app.review-b.integration.account.gov.uk"
      GTMCONTAINERID: "TK92W68"
      ANALYTICSCOOKIEDOMAIN: ".account.gov.uk"
      SERVICECOOKIEDOMAIN: ".account.gov.uk"
      ISSESSIONFINISHEDPOLLINGDURATION: "1800000" # 30 minutes in milliseconds
      ISSESSIONFINISHEDINTERVAL: "3000" # Time between API calls. 3 seconds in milliseconds
    production:
      OAUTHENABLED: true
      CLIENTSTUBENABLED: false
      MOBILESTUBENABLED: false
      DESKTOPJOURNEYENABLED: true
      IPVCOREINTEGRATIONENABLED: false
      MULTIPLELANGUAGESENABLED: false
      ANDROIDENABLED: false
      APPSTOREURL: "https://apps.apple.com/us/app/ipv-alpha/id1629050566"
      MOBILEAPPID: "N8W395F695.uk.gov.digital-identity"
      PLAYSTOREURL: "https://play.google.com/store/apps/details?id=uk.gov.documentchecking"
      ANDROIDAPPID: "uk.gov.documentchecking"
      ANDROIDFINGERPRINT: "69:2A:ED:C1:FE:8B:05:99:F1:9B:28:00:D5:E7:AD:DC:7C:24:EF:A0:06:B9:17:2D:00:9B:D2:EC:34:28:38:BC"
      FEURL: "www.review-b.account.gov.uk"
      APPURL: "app.review-b.account.gov.uk"
      GTMCONTAINERID: "TT5HDKV"
      ANALYTICSCOOKIEDOMAIN: ".account.gov.uk"
      SERVICECOOKIEDOMAIN: ".account.gov.uk"
      ISSESSIONFINISHEDPOLLINGDURATION: "1800000" # 30 minutes in milliseconds
      ISSESSIONFINISHEDINTERVAL: "3000" # Time between API calls. 3 seconds in milliseconds

Resources:
  # Security Groups for the ECS service and load balancer
  LoadBalancerSG:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: >-
        DCA Front LoadBalancer Security Group
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          Description: Allow from anyone on port 80
          FromPort: 80
          IpProtocol: tcp
          ToPort: 80
      VpcId:
        Fn::ImportValue:
          !Sub "${VpcStackName}-VpcId"

  LoadBalancerSGEgressToECSSecurityGroup:
    Type: 'AWS::EC2::SecurityGroupEgress'
    Properties:
      GroupId: !GetAtt LoadBalancerSG.GroupId
      IpProtocol: tcp
      Description: >-
        Egress between the DCA Front load balancer and
        the DCA Front ECS security group
      DestinationSecurityGroupId: !GetAtt ECSSecurityGroup.GroupId
      FromPort: !Ref ContainerPort
      ToPort: !Ref ContainerPort

  ECSSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: >-
        DCA Front ECS Security Group permitting outbound
        to anywhere.
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: '-1'
      VpcId:
        Fn::ImportValue:
          !Sub "${VpcStackName}-VpcId"

  ECSSecurityGroupIngressFromLoadBalancer:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      IpProtocol: tcp
      Description: >-
        DCA Front ECS permits inbound from the DCA Front
        load balancer.
      FromPort: !Ref ContainerPort
      ToPort: !Ref ContainerPort
      GroupId: !GetAtt ECSSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt LoadBalancerSG.GroupId

  AccessLogsBucket:
    Condition: IsNotDevelopment
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub dca-cri-front-${Environment}-access-logs
      VersioningConfiguration:
        Status: "Enabled"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

  DCAFrontAccessLogsBucketPolicy:
    Condition: IsNotDevelopment
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref AccessLogsBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub
                - "arn:aws:iam::${ElbAccountId}:root"
                - ElbAccountId: !FindInMap [ ElasticLoadBalancerAccountIds, !Ref AWS::Region, AccountId ]
            Action:
              - s3:PutObject
            Resource:
              - !Sub arn:aws:s3:::${AccessLogsBucket}/dca-front-${Environment}/AWSLogs/${AWS::AccountId}/*

  # Private Application Load Balancer
  LoadBalancer:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      Scheme: internal
      SecurityGroups:
        - !GetAtt LoadBalancerSG.GroupId
      Subnets:
        - Fn::ImportValue:
            !Sub "${VpcStackName}-PrivateSubnetIdA"
        - Fn::ImportValue:
            !Sub "${VpcStackName}-PrivateSubnetIdB"
        - Fn::ImportValue:
            !Sub "${VpcStackName}-PrivateSubnetIdC"
      Type: application
      LoadBalancerAttributes: !If
        - IsNotDevelopment
        - - Key: access_logs.s3.enabled
            Value: true
          - Key: access_logs.s3.bucket
            Value: !Ref AccessLogsBucket
          - Key: access_logs.s3.prefix
            Value: !Sub dca-front-${Environment}
        - !Ref AWS::NoValue

  LoadBalancerListenerTargetGroupECS:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: TRUE
      HealthCheckProtocol: HTTP
      Matcher:
        HttpCode: 200-499
      Port: 80
      Protocol: HTTP
      TargetType: ip
      VpcId:
        Fn::ImportValue:
          !Sub "${VpcStackName}-VpcId"
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: 60

  LoadBalancerListener:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn: !Ref LoadBalancerListenerTargetGroupECS
          Type: forward
      LoadBalancerArn: !Ref LoadBalancer
      Port: 80
      Protocol: HTTP

  # ECS cluster, service and task definition
  DCAFrontEcsCluster:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterSettings:
        - Name: containerInsights
          Value: enabled
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-ECSCluster"
        - Key: Product
          Value: "GOV.UK sign in"
        - Key: System
          Value: "DCA CRI"
        - Key: Environment
          Value: !Sub "${Environment}"

  DCAFrontEcsService:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster: !Ref DCAFrontEcsCluster
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 50
        DeploymentCircuitBreaker:
          Enable: TRUE
          Rollback: TRUE
      DesiredCount: 1
      EnableECSManagedTags: false
      HealthCheckGracePeriodSeconds: 60
      LaunchType: FARGATE
      LoadBalancers:
        - ContainerName: app
          ContainerPort: !Ref ContainerPort
          TargetGroupArn: !Ref LoadBalancerListenerTargetGroupECS
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - !GetAtt ECSSecurityGroup.GroupId
          Subnets:
            - Fn::ImportValue:
                !Sub "${VpcStackName}-PrivateSubnetIdA"
            - Fn::ImportValue:
                !Sub "${VpcStackName}-PrivateSubnetIdB"
            - Fn::ImportValue:
                !Sub "${VpcStackName}-PrivateSubnetIdC"
      TaskDefinition: !Ref ECSServiceTaskDefinition
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-ECS"
        - Key: Product
          Value: "GOV.UK sign in"
        - Key: System
          Value: "DCA CRI"
        - Key: Environment
          Value: !Sub "${Environment}"
    DependsOn:
      - LoadBalancerListener

  ECSAccessLogsGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/ecs/${AWS::StackName}-DCAFront-ECS
      RetentionInDays: 14

  CSLSECSAccessSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsNotDevelopment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESS]
      FilterPattern: ""
      LogGroupName: !Ref ECSAccessLogsGroup

  CSLSECSAccessSubscriptionFilterOLD:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsNotDevelopment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESSOLD]
      FilterPattern: ""
      LogGroupName: !Ref ECSAccessLogsGroup

  ECSServiceTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Essential: true
          Image: !If
            - IsNotDevelopment
            - CONTAINER-IMAGE-PLACEHOLDER
            - !Ref DevFrontendContainer
          Name: app
          Environment:
            - Name: API_BASE_URL # This is the same as API_URL
              Value: !If
                - IsNotDevelopment
                - !Sub
                  - "https://${Url}"
                  - Url:
                      Fn::ImportValue:
                        !Sub "${BackendStackName}-apigateway-url"
                - !Sub
                  - "https://${Url}"
                  - Url:
                      Fn::ImportValue:
                        !Sub "${BackendStackName}-apigateway-url-execute-url"
            - Name: EXTERNAL_WEBSITE_HOST
              Value: !GetAtt ApiGwHttpEndpoint.ApiEndpoint
            - Name: OAUTH_ENABLED
              Value: !FindInMap [EnvironmentVariables, !Ref Environment, OAUTHENABLED ]
            - Name: CLIENT_STUB_ENABLED
              Value: !FindInMap [EnvironmentVariables, !Ref Environment, CLIENTSTUBENABLED ]
            - Name: MOBILE_STUB_ENABLED
              Value: !FindInMap [EnvironmentVariables, !Ref Environment, MOBILESTUBENABLED ]
            - Name: X_GOVUK_SIGNIN_CIC_FEATURE_FLAG_20221108_CRI
              Value: !FindInMap [ EnvironmentVariables, !Ref Environment, DESKTOPJOURNEYENABLED ]
            - Name: X_GOVUK_SIGNIN_DCA_FEATURE_FLAG_20220929_IPV_CORE
              Value: !FindInMap [ EnvironmentVariables, !Ref Environment, IPVCOREINTEGRATIONENABLED ]
            - Name: X_GOVUK_SIGNIN_DCA_FEATURE_FLAG_20221013_MULTIPLE_LANGUAGES_ENABLED
              Value: !FindInMap [ EnvironmentVariables, !Ref Environment, MULTIPLELANGUAGESENABLED ]
            - Name: X_GOVUK_SIGNIN_DCA_FEATURE_FLAG_20221017_ANDROID
              Value: !FindInMap [ EnvironmentVariables, !Ref Environment, ANDROIDENABLED ]
              # Feature Flags - end
            - Name: ENVIRONMENT
              Value: !Sub "${Environment}"
            - Name: PORT
              Value: !Ref ContainerPort
            - Name: FRONT_END_URL
              Value: !Sub
                - "https://${Url}"
                - Url: !FindInMap [EnvironmentVariables, !Ref Environment, FEURL ]
            - Name: FRONT_END_URL_ALTERNATE_SUBDOMAIN
              Value: !Sub
                - "https://${Url}"
                - Url: !FindInMap [EnvironmentVariables, !Ref Environment, APPURL ]
            - Name: API_URL
              Value: !If
                - IsNotDevelopment
                - !Sub
                  - "https://${Url}"
                  - Url:
                      Fn::ImportValue:
                        !Sub "${BackendStackName}-apigateway-url"
                - !Sub
                  - "https://${Url}"
                  - Url:
                      Fn::ImportValue:
                        !Sub "${BackendStackName}-apigateway-url-execute-url"
            - Name: APP_STORE_URL
              Value: !FindInMap [EnvironmentVariables, !Ref Environment, APPSTOREURL ]
            - Name: MOBILE_APP_ID
              Value: !FindInMap [EnvironmentVariables, !Ref Environment, MOBILEAPPID ]
            - Name: PLAY_STORE_URL
              Value: !FindInMap [ EnvironmentVariables, !Ref Environment, PLAYSTOREURL ]
            - Name: ANDROID_APP_ID
              Value: !FindInMap [ EnvironmentVariables, !Ref Environment, ANDROIDAPPID ]
            - Name: ANDROID_FINGER_PRINT
              Value: !FindInMap [ EnvironmentVariables, !Ref Environment, ANDROIDFINGERPRINT ]
            - Name: GTM_CONTAINER_ID
              Value: !Sub
                - "GTM-${ContainerId}"
                - ContainerId: !FindInMap [EnvironmentVariables, !Ref Environment, GTMCONTAINERID ]
            - Name: ANALYTICS_COOKIE_DOMAIN
              Value: !FindInMap [EnvironmentVariables, !Ref Environment, ANALYTICSCOOKIEDOMAIN ]
            - Name: SERVICE_COOKIE_DOMAIN
              Value: !FindInMap [EnvironmentVariables, !Ref Environment, SERVICECOOKIEDOMAIN ]
            - Name: IS_SESSION_FINISHED_POLLING_DURATION
              Value: !FindInMap [EnvironmentVariables, !Ref Environment, ISSESSIONFINISHEDPOLLINGDURATION]
            - Name: IS_SESSION_FINISHED_INTERVAL
              Value: !FindInMap [EnvironmentVariables, !Ref Environment, ISSESSIONFINISHEDINTERVAL ]
          PortMappings:
            - ContainerPort: !Ref ContainerPort
              Protocol: tcp
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group : !Ref ECSAccessLogsGroup
              awslogs-region : !Sub ${AWS::Region}
              awslogs-stream-prefix : !Sub dca-front-${Environment}
      Cpu: '256'
      ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
      Memory: '512'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      TaskRoleArn: !GetAtt ECSTaskRole.Arn
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-TaskDefinition"
        - Key: Product
          Value: "GOV.UK sign in"
        - Key: System
          Value: "DCA CRI"
        - Key: Environment
          Value: !Sub "${Environment}"

  ECSTaskExecutionRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: 2012-10-17
      Policies:
        - PolicyName: PullDCAFrontImage
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "ecr:BatchGetImage"
                  - "ecr:GetDownloadUrlForLayer"
                  - "ecr:GetAuthorizationToken"
                Resource:
                  - '*'
              - Effect: Allow
                Action:
                  - "logs:CreateLogStream"
                  - "logs:PutLogEvents"
                Resource:
                  - !GetAtt "ECSAccessLogsGroup.Arn"
                  - !Sub "${ECSAccessLogsGroup.Arn}:*"
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  ECSTaskRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: 2012-10-17
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  ApiGwHttpEndpoint:
      Type: 'AWS::ApiGatewayV2::Api'
      Properties:
        Name: !Sub dca-front-${Environment}-${AWS::StackName}
        Description: !Sub "Document Check Mobile And Web (DCMAW) Frontend API. ${AWS::StackName}"
        ProtocolType: HTTP

  ApiGwHttpEndpointIntegration:
      Type: 'AWS::ApiGatewayV2::Integration'
      Properties:
        ApiId: !Ref ApiGwHttpEndpoint
        IntegrationType: HTTP_PROXY
        ConnectionId:
          Fn::ImportValue:
            !Sub "${VpcStackName}-VpcLinkId"
        ConnectionType: VPC_LINK
        IntegrationMethod: ANY
        IntegrationUri: !Ref LoadBalancerListener
        PayloadFormatVersion: '1.0'
        RequestParameters:
          overwrite:header.x-govuk-signin-source-ip: $context.identity.sourceIp

  APIGWRoute:
    Type: 'AWS::ApiGatewayV2::Route'
    Properties:
      ApiId: !Ref ApiGwHttpEndpoint
      RouteKey: 'ANY /{proxy+}'
      Target: !Join
        - /
        - - integrations
          - !Ref ApiGwHttpEndpointIntegration

  APIStageDefault:
    Type: 'AWS::ApiGatewayV2::Stage'
    Properties:
      ApiId: !Ref ApiGwHttpEndpoint
      StageName: $default
      AutoDeploy: true
      DefaultRouteSettings:
        DataTraceEnabled: false
        DetailedMetricsEnabled: true
        ThrottlingBurstLimit: 400
        ThrottlingRateLimit: 200
      AccessLogSettings:
        DestinationArn: !GetAtt APIGWAccessLogsGroup.Arn
        Format: >-
          {
          "requestId":"$context.requestId",
          "ip": "$context.identity.sourceIp",
          "requestTime":"$context.requestTime",
          "httpMethod":"$context.httpMethod",
          "path": "$context.path",
          "routeKey":"$context.routeKey",
          "status":"$context.status",
          "protocol":"$context.protocol",
          "responseLength":"$context.responseLength"
          }

  APIGWAccessLogsGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/apigateway/${AWS::StackName}-dcaFront-API-GW-AccessLogs

  CSLSAPIGWAccessSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsNotDevelopment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESS]
      FilterPattern: ""
      LogGroupName: !Ref APIGWAccessLogsGroup

  CSLSAPIGWAccessSubscriptionFilterOLD:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsNotDevelopment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESSOLD]
      FilterPattern: ""
      LogGroupName: !Ref APIGWAccessLogsGroup


# Autoscaling
# The number of pods will increase when the configured CPU utilization is breached for more than 3 minutes.
# Scaling down will occur after 15 minutes of 90% utilization of the configured CPU utilization.

  ECSAutoScalingTarget:
    Condition: IsProduction
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    Properties:
      MaxCapacity: 3
      MinCapacity: 1
      ResourceId: !Join
        - '/'
        - - "service"
          - !Ref   DCAFrontEcsCluster
          - !GetAtt DCAFrontEcsService.Name
      RoleARN: !Sub "arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService"
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs

  ECSAutoScalingPolicy:
    Condition: IsProduction
    DependsOn: ECSAutoScalingTarget
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: ECSAutoScalingPolicy
      PolicyType: TargetTrackingScaling
      ResourceId: !Join
        - '/'
        - - "service"
          - !Ref   DCAFrontEcsCluster
          - !GetAtt DCAFrontEcsService.Name
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs
      TargetTrackingScalingPolicyConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        TargetValue: 70.0

  ### www domain

  FrontCustomDomain:
    Type: AWS::ApiGatewayV2::DomainName
    Condition: IsNotDevelopment
    Properties:
      DomainName: !FindInMap [ EnvironmentVariables, !Ref Environment, FEURL ]
      DomainNameConfigurations:
        - CertificateArn: !Sub "{{resolve:ssm:/${Environment}/Platform/ACM/PrimaryZoneWildcardCertificateARN}}"
          EndpointType: REGIONAL
          SecurityPolicy: TLS_1_2

  FrontApiRecord:
    Type: AWS::Route53::RecordSet
    Condition: IsNotDevelopment
    Properties:
      Name: !FindInMap [EnvironmentVariables, !Ref Environment, FEURL ]
      Type: A
      HostedZoneId: !Sub "{{resolve:ssm:/${Environment}/Platform/Route53/PrimaryZoneID}}"
      AliasTarget:
        DNSName: !GetAtt FrontCustomDomain.RegionalDomainName
        HostedZoneId: !GetAtt FrontCustomDomain.RegionalHostedZoneId
        EvaluateTargetHealth: false

  FrontApiMapping:
    Type: AWS::ApiGatewayV2::ApiMapping
    Condition: IsNotDevelopment
    Properties:
      DomainName: !FindInMap [EnvironmentVariables, !Ref Environment, FEURL ]
      ApiId: !Ref ApiGwHttpEndpoint
      Stage: "$default"
    DependsOn:
      - FrontCustomDomain


  # app domain
  AppFrontCustomDomain:
    Condition: IsNotDevelopment
    Type: AWS::ApiGatewayV2::DomainName
    Properties:
      DomainName: !FindInMap [EnvironmentVariables, !Ref Environment, APPURL ]
      DomainNameConfigurations:
        - CertificateArn: !Sub "{{resolve:ssm:/${Environment}/Platform/ACM/PrimaryZoneWildcardCertificateARN}}"
          EndpointType: REGIONAL
          SecurityPolicy: TLS_1_2

  AppFrontApiRecord:
    Condition: IsNotDevelopment
    Type: AWS::Route53::RecordSet
    Properties:
      Name: !FindInMap [EnvironmentVariables, !Ref Environment, APPURL ]
      Type: A
      HostedZoneId: !Sub "{{resolve:ssm:/${Environment}/Platform/Route53/PrimaryZoneID}}"
      AliasTarget:
        DNSName: !GetAtt AppFrontCustomDomain.RegionalDomainName
        HostedZoneId: !GetAtt AppFrontCustomDomain.RegionalHostedZoneId
        EvaluateTargetHealth: false

  AppFrontApiMapping:
    Condition: IsNotDevelopment
    Type: AWS::ApiGatewayV2::ApiMapping
    Properties:
      DomainName: !FindInMap [EnvironmentVariables, !Ref Environment, APPURL ]
      ApiId: !Ref ApiGwHttpEndpoint
      Stage: "$default"
    DependsOn:
      - AppFrontCustomDomain



Outputs:
  DCAFrontUrl:
    Description: >-
      The API Gateway URL which DCA Front can be invoked on.
    Value: !GetAtt  ApiGwHttpEndpoint.ApiEndpoint
  DCAFrontGatewayId:
    Description: DCA Front API Gateway ID
    Export:
      Name: !Sub "${AWS::StackName}-DCAFrontGatewayId"
    Value: !Ref ApiGwHttpEndpoint